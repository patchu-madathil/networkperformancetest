<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Network Performance Test (ndt7)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1>Network Performance Test (ndt7)</h1>

    <div id="controls">
      <button id="startBtn" disabled>Start Test</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <section id="serverSection" class="card">
      <h2>Server</h2>
      <div id="server">Not selected</div>
    </section>

    <section id="results" class="grid">
      <div class="card">
        <h3>Download</h3>
        <div id="download">—</div>
      </div>
      <div class="card">
        <h3>Upload</h3>
        <div id="upload">—</div>
      </div>
      <div class="card">
        <h3>Latency</h3>
        <div id="latency">—</div>
      </div>
      <div class="card">
        <h3>Status / Log</h3>
        <pre id="log" class="log">Waiting for ndt7 library...</pre>
      </div>
    </section>

    <p class="note">This page uses M-Lab's ndt7 client via CDN. If ndt7 fails to load, check the browser console and the Network tab.</p>

    <footer>
      <small>Built with ndt7-js (M-Lab). Source: <a href="https://github.com/m-lab/ndt7-js" target="_blank" rel="noopener">m-lab/ndt7-js</a></small>
    </footer>
  </main>

  <!-- Attempt to load ndt7 library from CDN (primary include) -->
  <script src="https://cdn.jsdelivr.net/npm/@m-lab/ndt7/dist/ndt7.min.js"></script>

  <!-- Fallback loader + readiness notifier -->
  <script>
    // Try to ensure ndt7 is available and notify the app
    (function() {
      const startBtn = document.getElementById('startBtn');
      const logEl = document.getElementById('log');

      function setLog(msg) {
        const time = new Date().toISOString().substr(11,8);
        logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
      }

      // If ndt7 already present, enable start
      if (window.ndt7) {
        setLog('ndt7 library loaded (cdn).');
        startBtn.disabled = false;
        return;
      }

      // Otherwise, try to load dynamically and poll for window.ndt7
      setLog('ndt7 not found—attempting dynamic load...');
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@m-lab/ndt7/dist/ndt7.min.js';
      s.crossOrigin = 'anonymous';
      s.onload = () => {
        setLog('ndt7 loaded via dynamic script.');
        startBtn.disabled = false;
      };
      s.onerror = () => {
        setLog('Failed to load ndt7 from CDN. You can try another CDN or verify network access.');
        // still poll for a short while in case of delayed load
        let tries = 0;
        const poll = setInterval(() => {
          tries++;
          if (window.ndt7) {
            clearInterval(poll);
            setLog('ndt7 became available.');
            startBtn.disabled = false;
            return;
          }
          if (tries > 30) { // ~6 seconds
            clearInterval(poll);
            setLog('ndt7 not available after retries.');
          }
        }, 200);
      };
      document.head.appendChild(s);
    })();
  </script>

  <script src="script.js"></script>
</body>
</html>